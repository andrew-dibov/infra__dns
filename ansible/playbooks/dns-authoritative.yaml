---
- name: "AUTH"
  become: true
  hosts:
    - au-a
    - au-b
  vars_files:
    - "../variables/common.yaml"
    - "../variables/terraform.yaml"

  vars:
    zone: "subdomain.domain"
    root_zone: "."
    root_ns: "ns.root."
    soa_mname: "ns.au-a.subdomain.domain."
    soa_rname: "admin.subdomain.domain."
    primary_ns: "ns.au-a.subdomain.domain."
    secondary_ns: "ns.au-b.subdomain.domain."
    www_record: "www"
    www_record_a: "wwa"
    www_record_b: "wwb"

  tasks:
    - name: "AUTH : update"
      ansible.builtin.apt:
        update_cache: true

    - name: "AUTH : install"
      ansible.builtin.apt:
        state: present
        name:
          - bind9
          - bind9utils
          - dnsutils

    - name: "AUTH : stop service"
      ansible.builtin.systemd:
        name: bind9
        state: stopped

    - name: "AUTH : remove config dir"
      ansible.builtin.file:
        path: "{{ bind_path }}"
        state: absent

    - name: "AUTH : create config dir"
      ansible.builtin.file:
        path: "{{ bind_path }}"
        state: directory
        owner: root
        group: bind
        mode: '0755'

    - name: "AUTH : create named.conf"
      ansible.builtin.template:
        src: "{{ templates_path }}/authoritative/auth.conf.j2"
        dest: "{{ bind_path }}/named.conf"
        owner: root
        group: bind
        mode: '0644'

    - name: "AUTH : create zones dir"
      ansible.builtin.file:
        path: "{{ zone_path }}"
        state: directory
        owner: bind
        group: bind
        mode: '0755'

    - name: "AUTH : create zones"
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: bind
        mode: '0644'
      loop:
        - { src: "{{ templates_path }}/authoritative/db.auth.j2", dest: "{{ zone_path }}/db.auth" }
        - { src: "{{ templates_path }}/common/db.root.hints.j2", dest: "{{ zone_path }}/db.root.hints" }
        - { src: "{{ templates_path }}/common/db.local.j2", dest: "{{ zone_path }}/db.local" }
        - { src: "{{ templates_path }}/common/db.0.j2", dest: "{{ zone_path }}/db.0" }
        - { src: "{{ templates_path }}/common/db.127.j2", dest: "{{ zone_path }}/db.127" }
        - { src: "{{ templates_path }}/common/db.255.j2", dest: "{{ zone_path }}/db.255" }

    - name: "AUTH : check named.conf"
      ansible.builtin.command:
        cmd: "named-checkconf {{ bind_path }}/named.conf"
      register: conf_status
      failed_when: conf_status.rc != 0
      changed_when: false

    - name: "AUTH : check db.auth"
      ansible.builtin.command:
        cmd: "named-checkzone {{ zone }} {{ zone_path }}/db.auth"
      register: zone_status
      failed_when: zone_status.rc != 0
      changed_when: false

    - name: "AUTH : create logs dir"
      ansible.builtin.file:
        path: "{{ bind_logs_path }}"
        state: directory
        owner: root
        group: bind
        mode: '0755'

    - name: "AUTH : create logs file"
      ansible.builtin.file:
        path: "{{ bind_logs_path }}/{{ bind_query_logs_file }}"
        state: touch
        owner: bind
        group: bind
        mode: '0644'

    - name: "AUTH : reload and restart service"
      ansible.builtin.systemd:
        name: bind9
        state: restarted
        enabled: true
        daemon_reload: true
